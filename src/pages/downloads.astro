---
import Layout from '../layouts/Layout.astro';
import MainContainer from '../components/MainContainer.astro';
import NavigationBar from '../components/navigation/NavigationBar.astro';
import Footer from '../components/Footer.astro';
import DownloadPlatform from '../components/DownloadPlatform.astro';

// This doesn't really matter, it's just a placeholder for the links, before they are updated by the script
const DEFAULT_VERSION = '0.6.6';

const GITHUB_RELEASES_BASE_URL = 'https://github.com/oktana-coop/v2/releases/download';

const downloads = [
  {
    category: "macOS",
    icon: "fa-apple",
    assets: [
      { name: "Universal", file: `v2-${DEFAULT_VERSION}-universal.dmg`, recommended: true },
      { name: "Intel", file: `v2-${DEFAULT_VERSION}.dmg` },
      { name: "Apple Silicon", file: `v2-${DEFAULT_VERSION}-arm64.dmg` }
    ]
  },
  {
    category: "Windows", 
    icon: "fa-windows",
    assets: [
      { name: "Installer", file: `v2-Setup-${DEFAULT_VERSION}.exe` }
    ]
  },
  {
    category: "Linux",
    icon: "fa-linux",
    assets: [
      { name: "AppImage", file: `v2-${DEFAULT_VERSION}-x86_64.AppImage`, recommended: true },
      { name: "AppImage (ARM64)", file: `v2-${DEFAULT_VERSION}-arm64.AppImage` },
      { name: "Deb", file: `v2-${DEFAULT_VERSION}-amd64.deb` },
      { name: "Deb (ARM64)", file: `v2-${DEFAULT_VERSION}-arm64.deb` },
      { name: "RPM", file: `v2-${DEFAULT_VERSION}-x86_64.rpm` },
      { name: "RPM (ARM64)", file: `v2-${DEFAULT_VERSION}-aarch64.rpm` }
    ]
  }
];
---

<Layout title="Download V2 - All Platforms and Formats">
  <MainContainer>
    <NavigationBar />
    <div class="max-w-4xl mx-auto p-6">
      
      <div class="text-center mb-8">
        <h1 class="text-3xl font-semibold mb-2">Download V2</h1>
        <p class="text-gray-500 text-sm" id="version-display" style="opacity: 0; transition: opacity 0.3s;">v{DEFAULT_VERSION}</p>
      </div>

      <div class="space-y-8" id="downloads-container">
        {downloads.map(platform => (
          <DownloadPlatform 
            category={platform.category}
            icon={platform.icon}
            assets={platform.assets}
            version={DEFAULT_VERSION}
            baseUrl={GITHUB_RELEASES_BASE_URL}
          />
        ))}
      </div>

      <div class="text-center mt-8 pt-6 border-t border-gray-100">
        <p class="text-sm text-gray-500">View all releases on <a href="https://github.com/oktana-coop/v2/releases" target="_blank" class="text-purple-500 hover:text-purple-600 font-medium">GitHub</a></p>
      </div>
    </div>
    
    <Footer />
  </MainContainer>
</Layout>

<script is:inline define:vars={{ GITHUB_RELEASES_BASE_URL }}>
  async function updateDownloadLinks() {
    try {
      // Fetch latest version from GitHub API
      const response = await fetch('https://api.github.com/repos/oktana-coop/v2/releases/latest');
      if (!response.ok) {
        console.warn('Could not fetch latest version, using fallback');
        return;
      }
      
      const data = await response.json();
      const latestVersion = data.tag_name.replace(/^v/, '');

      // Update version display
      const versionDisplay = document.getElementById('version-display');
      if (versionDisplay) {
        versionDisplay.textContent = `v${latestVersion}`;
        versionDisplay.style.opacity = '1'; // Fade in the version
      }

      // Create a map of asset names to their download URLs
      const assetMap = {};
      data.assets.forEach(asset => {
        assetMap[asset.name] = asset.browser_download_url;
      });

      // Update all download links
      const downloadLinks = document.querySelectorAll('.download-link');
      downloadLinks.forEach(link => {
        const originalFile = link.getAttribute('data-file');
        if (originalFile) {
          // Generate the expected filename for the new version
          const expectedFileName = originalFile.replace(/\d+\.\d+\.\d+/g, latestVersion);
          
          // Use the actual browser_download_url from the API
          if (assetMap[expectedFileName]) {
            link.href = assetMap[expectedFileName];
          }
        }
      });

    } catch (error) {
      console.warn('Failed to update download links:', error);
    }
  }

  // Run when the page loads
  updateDownloadLinks();
</script>
